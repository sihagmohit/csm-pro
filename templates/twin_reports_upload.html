{% extends "template.html" %}
{% block content %}
<style>
:root {
   --windows-blue: #365ec8;
   --bluish: #3091c9;
   --warm-blue: #5460dc;
   --white: #ffffff;
   --dusk-blue: #28499f;
   --bluey-grey: #85a5c2;
   --light-sky-blue: #d4e3f0;
   --lipstick: #bb166b;
   --bluish-grey-20: rgba(115, 137, 156, 0.2);
   --topaz: #16b8bb;
   --aquamarine: #00d7af;
   --metallic-blue: #546593;
   --bluish-grey: #73899c;
   --very-light-pink: #d7d7d7;
   --gray-medium: rgba(205, 205, 210, 0.5);
   --text: #77777a;
   ---style: #002251;
}
.Rectangle {
   font-family: Montserrat;
   font-size: 12px;
   font-weight: 300;
   font-stretch: normal;
   font-style: normal;
   line-height: normal;
   letter-spacing: 1.75px;
   text-align: center;
   color: var(--white);
   border-radius: 5px;
   box-shadow: 0 2px 6px 0 #b9b9b9;
   background-color: var(--windows-blue);
}
.Rectangle_without_color {
   font-family: Montserrat;
   font-size: 12px;
   font-weight: 400;
   font-stretch: normal;
   font-style: normal;
   line-height: normal;
   letter-spacing: 1.75px;
   text-align: center;
   color: var(--white);
   border-radius: 5px;
   box-shadow: 0 2px 6px 0 #B9B9B9;
}
.dataTables_scrollHeadInner{  width:100% !important; }
.dataTables_scrollHeadInner table{  width:100% !important; }
</style>
<div class="row mg-b-1 mg-l-5">
   <button type="button" class="btn btn-light" onclick="back()"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>
</div>
<script type="text/javascript">
   function back(){
      window.history.back();
   }
</script>
<div class="card mg-t-20 ">
   <div class="card-header">
      <div class="tx-dark tx-15 tx-bold">REPORTS
      </div>
   </div>
   <!-- card-header -->
   <div class="card-body ">
      <!-- ====================== Row Start ================================== -->
      <div class='row '>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">RPO</label>
               <input type="text" class="form-control form-control-sm" id="rpo" readonly>
            </div>
         </div>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Client Name</label>
               <input type="text" class="form-control form-control-sm" id="client_name" readonly>
            </div>
         </div>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Machine Type</label>
               <input type="text" class="form-control form-control-sm" id="machine_type" readonly>
            </div>
         </div>
      </div>
      <!-- ====================== Row End ================================== -->
      <div class='row '>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Delivery Date</label>
               <input type="date" style="height:31px;" class="form-control base" id="delivery_date" placeholder="dd/MM/YYYY" readonly>
            </div>
         </div>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Point of Contact</label>
               <input type="text" class="form-control form-control-sm" id="poc" readonly>
            </div>
         </div>
         <div class='col-lg-4 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Machine Subtype</label>
               <input type="text" class="form-control form-control-sm" id="machine_subtype" readonly>
            </div>
         </div>
      </div>
      <!-- ====================== Row End ================================== -->
      <div class='row '>
         <div class='col-lg-12 col-md-12'>
            <div class="form-group">
               <label class="tx-black">Current Status</label>
               <div class="progress" style="height: 50px;" id="total_status"></div>
            </div>
         </div>
      </div>
      <!-- ====================== Row End ================================== -->
   </div>
</div>
<div class="d-flex justify-content-end mg-t-10">
   <!--<div class="p-2 btn btn-sm Rectangle" onclick="myCreateFunction()" >IMPORT</div>&nbsp;-->
   <div class="p-2 btn btn-sm Rectangle" type="button" data-toggle="modal" onclick="open_modal()"> + ADD NEW REPORT</div>
</div>
<br><br>


<!--------------------------------------------------------modal for new report--------------------------------------------------------->

<div class="modal fade" id="exampleModal1" >
 <div class="modal-dialog modal-lg" role="document">
  <div class="modal-content">

   <!-- Modal Header -->
   <div class="modal-header">
    <h6 class="tx-14 mg-b-0 tx-uppercase tx-inverse tx-bold " id="heading">New Report</h6>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
 </div>
 <form  enctype="multipart/form-data" action="/report_uploader" method="post" name="reportUploaderForm" id="modal_form" >
    <!-- Modal body -->
    <div class="modal-body">
     <div class="row justify-content-center">

      <div class="col-lg-12 col-md-12 col-sm-12">

       <input type="hidden" class="form-control form-control-sm modal_text_input" id="modal1_rpo" name="modal1_rpo_name">

       <label class="tx-black">Report Name </label>
       <input type="text" class="form-control" id="modal1_report_name_id" name="modal1_report_name"><br>

       <input type="file" name="fileToUpload" id="fileToUpload1" accept="*" required>
       <small id="upload_help" class="form-text text-muted">Choose the file to upload.</small><br>

       <label class="tx-black">Note</label>
       <input type="text" class="form-control" id="note" name="modal1_report_note">
       <br><br>

    </div>

 </div>
</div>
<!-- Modal footer -->
<center><div class="mt-2 mb-3">

  <input type="submit" class="btn btn-success mr-2" style="width: 30%;"  value="SAVE">
  <button type="button" class="btn btn-danger" style="width: 30%;" data-dismiss="modal">CLOSE</button>
</div></center></form>

</div>
</div>
</div>

<!---------------------------------------------------------------------------------------------------------------------------->


<div class="btn-toolbar justify-content-between pt-2" role="toolbar" aria-label="Toolbar with button groups">
   <div id="table_button">
   </div>
   <!-- <input type="text" class="form-control" placeholder="Search" id="search_table"> -->
   <div class="input-group">
      <input type="text" id="datatable1_search" class="form-control" placeholder="Search" >
   </div>
</div>
<table class="table table-sm table-striped table-bordered pt-2 pb-2" style="width:100%" id="report_table">
   <thead class="bg-dark tx-white">
      <tr>
         <th>SR.NO.</th>
         <th>REPORT NAME</th>
         <th>DETAILS</th>
         <th>TIMESTAMP</th>
         <th>DOWNLOAD</th>
         <th>ACTION</th>
      </tr>
   </thead>
   <tbody id="tablebody">
   </tbody>
</table>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" ></script>
<script>
   var socket=io.connect('http://'+document.domain+":"+location.port)
   
   var rpo = '{{rpo}}';
   
   socket.emit("get_client_info",rpo);
   
   socket.on('sent_client_info', function(data) {
     $('#report_table').dataTable().fnDestroy();

     document.getElementById("rpo").value = data["RPO"];
     document.getElementById("client_name").value = data["Client Name"];
     document.getElementById("machine_type").value = data["Machine Type"];
     document.getElementById("delivery_date").value = data["Delivery Date"];
     document.getElementById("poc").value = data["POC"];
     document.getElementById("machine_subtype").value = data["Machine Subtype"]

     var num = data["Total Status %"];
     num1 = num.replace("%","");
     var num2 = parseFloat(num1);
     var n = num2.toFixed(2);
     var n_str = n.toString();

     var total_status = n_str + "%";

     inner_html1 = "";
     inner_html1 += '<div class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: '+n+'%;height: 50px;" >';
     inner_html1 += '<center><b><label style="padding-top:18px;font-size: 15px;">'+total_status+'</label></b></center></div>';
     document.getElementById("total_status").innerHTML = inner_html1;

     var reports = data["reports"]
     var inner_html = "";
     for(var j=0; j< reports.length;j++){

      var temp = reports[j]["path"].split("/")
      var file_path = temp.join("^");

      inner_html += '<tr>'
      inner_html += '<td>'+String(j+1)+'</td>';
      inner_html += '<td>'+reports[j]["report_name"]+'</td>';
      inner_html += '<td>'+reports[j]["report_note"]+'</td>';
      inner_html += '<td>'+reports[j]["timestamp"]+'</td>';
      inner_html += '<td><center>';
      inner_html += '<a href="/download/'+file_path+'"><div class="btn btn-sm btn-primary Rectangle_without_color">Download</div>';
      inner_html += '</a></center></td>';
      inner_html += '<td style="text-align:center"><button type="button" class="btn btn-sm btn-dark Rectangle_without_color" id="' + reports[j]["report_name"]+'|||'+reports[j]["timestamp"]+'"onclick="delete_report(this)">DELETE</button> </td>';
      inner_html += '</tr>';

   }

   
   document.getElementById("tablebody").innerHTML = inner_html;
   
   var table1 = $('#report_table').DataTable( {
         //"scrollX": true,
         lengthChange: false,
         "dom": 'lrtip',
         "deferRender": true,
         "initComplete": function (settings, json) {
           $("#report_table").wrap("<div style='overflow:auto; width:100%;position:relative;'></div>");
        },


        buttons: [
        {
           extend: 'collection',
           text: 'Export',
           autoClose: true,
           buttons: [
           {
              extend:    'copy',
              text:      '<img src="/static/img/ICONS/copy.png" style="height:24px"></img> Copy ',
              titleAttr: 'Copy'
           },
           {
              extend:    'excel',
              text:      '<img src="/static/img/ICONS/excel.png" style="height:24px"></img> Excel ',
              titleAttr: 'Excel'
           },
           {
              extend:    'pdf',
              text:      '<img src="/static/img/ICONS/pdf.png" style="height:24px"></img> PDF ',
              titleAttr: 'PDF'
           },
           {
              extend:    'print',
              text:      '<img src="/static/img/ICONS/print.png" style="height:24px"></img> Print ',
              titleAttr: 'Print'
           },
           {
              extend:    'csv',
              text:      '<img src="/static/img/ICONS/csv.png" style="height:24px"></img> CSV ',
              titleAttr: 'CSV'
           },
           {
              extend:    'colvis',
              text:      '<img src="/static/img/ICONS/columns.png" style="height:24px"></img> Columns ',
              titleAttr: 'Columns'
           },
           ]
        }
        ]


     } );
   table1.buttons( 0, null ).containers().appendTo( '#table_button' );
   
   // #myInput is a <input type="text"> element
   $('#datatable1_search').on( 'keyup', function () {
     table1.search( this.value ).draw();
     console.log("working")
  } );   
   
   }); // scoket



function save_details(){

   var rpo = '{{rpo}}';
   var path = '{{path}}';
   console.log(path);
   
   var report_name = document.getElementById("report_name").value;
   var note = document.getElementById("note").value;
   var filename = filename_global;
   
   if(report_name.length > 0 && note.length > 0){

      var report_details = {};

      report_details["RPO"] = rpo;

      report_details["Report Name"] = report_name;
      report_details["Filename"] = filename;
      report_details["Report Note"] = note;
      report_details["Report Relative Path"] = path_global;
      console.log(report_details);
      socket.emit("save_report_details",report_details);

      $('#exampleModal1').modal('hide');

   }
   
   socket.emit("get_client_info",rpo);
   
}


function delete_report(element){

  var ids = element.id
  var temp  = ids.split("|||")
  console.log(temp[0])
  console.log(temp[1])

  to_send = {"RPO": document.getElementById("rpo").value,
  "file_name":temp[0],"timestamp":temp[1]}


  socket.emit("delete_report",to_send);
  socket.emit("get_client_info",rpo);

}

function open_modal(){
 $('#modal_form')[0].reset();
 document.getElementById("upload_help").innerHTML = "Choose the file to upload.";
 document.getElementById("modal1_rpo").value = document.getElementById("rpo").value;

 $('#exampleModal1').modal('show')
}


// File Upload .....................

var form = document.forms.namedItem("reportUploaderForm");
form.addEventListener('submit', function(event) {
  var formatData = new FormData(form);
  console.log(formatData);
  var formatRequest = new XMLHttpRequest();

  formatRequest.open("POST", "/report_uploader", true);
  formatRequest.onload = function(oEvent) {
    if (formatRequest.status == 200) {
      document.getElementById("upload_help").innerHTML = "File Uploaded Successfully ! "
      socket.emit("get_client_info",'{{rpo}}');
   } else {
      document.getElementById("upload_help").innerHTML = "Error occured in uploading file! "
   }
};
formatRequest.send(formatData);
event.preventDefault();
}, false);


</script>
{% endblock %}